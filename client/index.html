<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <title>PICO-8 Cartridge</title>
        <meta name="description" content="">

<STYLE TYPE="text/css">
<!--

html {
	color: white;
}

h1 {
	color: #ff004d;
	text-decoration: underline;
	text-decoration-color: white;
}

.gpio_values {
	margin-top: 1rem;
	display: -webkit-box;
  display: flex;
  -webkit-box-pack: center;
          justify-content: center;
}

.gpio_values > * {
	font-weight: bold;
	font-size: 24px;
	width: 50px;
}

.gpio_values > *.new {
	color: #ff004d; /* pico-8 red */
}

canvas#canvas { width: 384px; height: 384px; }

.pico8_el {
	float:left;
	width:92px;
	display:inline-block; 
  	margin: 1px;
	padding: 4px;
	text-align: center;
	color:#fff;
	background-color:#777;
	font-family : verdana;
	font-size: 9pt;
	cursor: pointer;
	cursor: hand;
}
.pico8_el a{
	text-decoration: none;
	color:#fff;
}

.pico8_el:hover{
	background-color:#aaa;
}

.pico8_el:link{
	background-color:#aaa;
}

canvas{
    image-rendering: optimizeSpeed;
    image-rendering: -moz-crisp-edges;
    image-rendering: -webkit-optimize-contrast;
    image-rendering: optimize-contrast;
    image-rendering: pixelated;
    -ms-interpolation-mode: nearest-neighbor;
    border: 0px
}

-->
</STYLE>
    
</head>

<body bgcolor=#303030>

	<br><br><br>

	<center><div style="width:512px;">

	<h1>PICO-8 AP Client</h1>

	<canvas class="emscripten" id="canvas" oncontextmenu="event.preventDefault()"></canvas>

	<script type="text/javascript">
		var canvas = document.getElementById("canvas");
		canvas.width = window.innerWidth;
		canvas.height = window.innerHeight;

		// show Emscripten environment where the canvas is
		// arguments are passed to PICO-8
		
		var Module = {};
		Module.canvas = canvas;
		
		/*
			// When pico8_buttons is defined, PICO-8 takes each int to be a live bitfield
			// representing the state of each player's buttons
			
			var pico8_buttons = [0, 0, 0, 0, 0, 0, 0, 0]; // max 8 players
			pico8_buttons[0] = 2 | 16; // example: player 0, RIGHT and Z held down
			
			// when pico8_gpio is defined, reading and writing to gpio pins will
			// read and write to these values
			var pico8_gpio = new Array(128);
		*/
	</script>

	<script async type="text/javascript" src="index.js"></script>
	  
	<script>
		// key blocker. prevent cursor keys from scrolling page while playing cart.
		
		function onKeyDown_blocker(event) {
			event = event || window.event;
			var o = document.activeElement;
			if (!o || o == document.body || o.tagName == "canvas")
			{
				if ([32, 37, 38, 39, 40].indexOf(event.keyCode) > -1)
				{
					if (event.preventDefault) event.preventDefault();
				}
			}
		}

		document.addEventListener('keydown', onKeyDown_blocker, false);

	</script>
        
	<br>

	<div class=pico8_el onclick="Module.pico8Reset();">

	<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAAaklEQVR4Ae2dOwoAMQhE15A+rfc/3bZ7AlMnQfywCkKsfcgMM9ZP+QHtIn0vLeBAFduiFdQ/0DmvtR5LXJ6CPSXe2ZXcFNlTxFbemKrbZPs35XogeS9xeQr+anT6LzoOwEDwZJ7jwhXUnwkTTiDQ2Ja34AAAABB0RVh0TG9kZVBORwAyMDExMDIyMeNZtsEAAAAASUVORK5CYII=" alt="Reset" width=12 height=	12/>

	Reset</div>

	<div class=pico8_el onclick="Module.pico8TogglePaused();">

	<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAAPUlEQVR4Ae3doQ0AIAxEUWABLPtPh2WCq26DwFSU/JPNT166QSu/Hg86W9dwLte+diP7AwAAAAAAgD+A+jM2ZAgo84I0PgAAABB0RVh0TG9kZVBORwAyMDExMDIyMeNZtsEAAAAASUVORK5CYII=" alt="Pause" width=12 height=12/>

	Pause</div>
	<div class=pico8_el onclick="Module.requestFullScreen(true, false);">
	<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAAaklEQVR4Ae2dsQ1AIQhExfze1v2ns3UCrfgFhmgUUAoGgHscp21wX9BqaZoDojbB96OkDJKNcTN2BHTyYNYmoT2BlPL7BKgcPfHjAVXKKadkHOn9K1r16N0czN6a95N8mnA7Aq2fTZ3Af3UKmCSMazL8HwAAABB0RVh0TG9kZVBORwAyMDExMDIyMeNZtsEAAAAASUVORK5CYII=" alt="Fullscreen" width=12 height=12/>

	Fullscreen</div>
	<div class=pico8_el onclick="Module.pico8ToggleSound();">
	<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAAXklEQVR4Ae2doQ4AIQxD4YLH8v9fh+ULhjpxxSwLg2uyapr1JRu1iV5Z+1BGl4+xNpX38SYo2uRvYiT5LwEmt+ocgXVLrhPEgBiw8Q5w7/kueSkK+D2tJO4E/I3GrwkqQCBabEj/4QAAABB0RVh0TG9kZVBORwAyMDExMDIyMeNZtsEAAAAASUVORK5CYII=" alt="Toggle Sound" width=12 height=12/>
	
	Sound</div>
	<div class=pico8_el ><a target="_new" href="http://www.lexaloffle.com/bbs/?cat=7&sub=2">
	<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAAlElEQVR4Ae2dMQ5FQBCGh6jcwAkkateg3DiAa+iQUGqVKi95FQfAJRQOoHeBUf8JyQqKjZ1uMzuz2e/LTE3KhyF7kSlgLOykas23f6D+A9Yp84aAOYU15pcJnfji0Il2ID8HzC4y38ZrnfIBGxeRoR3c3EWrACdsV5BOsx7OSRnrOXh4F5HzA6bevwUn8wlz7eCDsQM99B3ks0s/4QAAABB0RVh0TG9kZVBORwAyMDExMDIyMeNZtsEAAAAASUVORK5CYII=" alt="More Carts" width=12 height=12/>

	Carts</a></div>

	</div>

	<br><br>	

	<div id="mainDiv">
		<form id="connection_details">
			<label for="fname">Hostname:</label>
			<input type="text" id="Hostname" name="Hostname"><br><br>

			<label for="fname">Port:</label>
			<input type="text" id="Port" name="Port"><br><br>

			<label for="fname">Name:</label>
			<input type="text" id="Name" name="Name"><br><br>
			<input type="submit" value="Submit">
		</form>
	</div></center>
	<br><br>

	<script src="pico8-gpio-listener.js"></script>
    <script type="module">
        import {
            Client,
            ITEMS_HANDLING_FLAGS,
            SERVER_PACKET_TYPE,
            CLIENT_STATUS ,
        } from "https://unpkg.com/archipelago.js@1.0.0/dist/archipelago.js";

        // Create a new Archipelago client
        const client = new Client();
		const form = document.getElementById("connection_details")

        //pico-8 related declarations
		var gpio = getP8Gpio();
		const loc_flags = {
			"mayor delivery": 			[0, 0b00000001, 0 ],
			"friend delivery": 			[0, 0b00000010, 2 ],
			"Climber delivery": 		[0, 0b00000100, 4 ],
			"climber cargo": 			[0, 0b00001000, 6 ],
			"friend freight": 			[0, 0b00010000, 7 ],
			"mayor missive": 			[0, 0b00100000, 8 ],
			"buried bento": 			[0, 0b01000000, 9 ],
			"grandpa goods": 			[0, 0b10000000, 10],
			"wife word": 				[1, 0b00000001, 11],
			"paper pack": 				[1, 0b00000010, 12],
			"driller delivery": 		[1, 0b00000100, 13],
			"paper folder delivery": 	[1, 0b00001000, 15],
			"mouse delivery": 			[1, 0b00010000, 17],
			"history haul": 			[1, 0b00100000, 19],
			"grandpa delivery": 		[1, 0b01000000, 20],
			"history buff delivery": 	[1, 0b10000000, 22],
			"wife delievery": 			[2, 0b00000001, 24],
			"driller dispatch": 		[2, 0b00000010, 26],
			"victory": 					[2, 0b00000100, 27],
			"mayor chat":				[3, 0b00001000, 1 ],
			"friend chat":				[3, 0b00010000, 3 ],
			"climber chat":				[3, 0b00100000, 5 ],
			"driller chat":				[3, 0b01000000, 14],
			"paper folder chat":		[3, 0b10000000, 16],
			"mouse chat":				[4, 0b00000001, 18],
			"grandpa chat":				[4, 0b00000010, 21],
			"history buff chat":		[4, 0b00000100, 23],
			"wife chat": 				[4, 0b00001000, 25],
		}

		const item_flags = {
			"mayor missive": 			[5, 0b00000001, 0],
			"friend freight": 			[5, 0b00000010, 1],
			"climber cargo": 			[5, 0b00000100, 2],
			"driller dispatch": 		[5, 0b00001000, 3],
			"paper pack": 				[5, 0b00010000, 4],
			"buried bento": 			[5, 0b00100000, 5],
			"grandpa goods": 			[5, 0b01000000, 6],
			"history haul": 			[5, 0b10000000, 7],
			"wife word": 				[6, 0b00000001, 8],
			"claw": 					[6, 0b00000010, 9],
			"fly": 						[6, 0b00000100, 10],
			"key": 						[6, 0b00001000, 11],
			"drill": 					[6, 0b00010000, 12],
			"Feeling of Satisfaction": 	[6, 0b00100000, 13],
		}
		const base_id = 19827412012

        // Set up event listeners
        client.addListener(SERVER_PACKET_TYPE.CONNECTED, (packet) => {
            console.log("Connected to server: ", packet);
        });

        client.addListener(SERVER_PACKET_TYPE.ROOM_UPDATE, (packet) => {
            console.log("Room update: ", packet);
        });

        //add item handler for gpio layer
		client.addListener(SERVER_PACKET_TYPE.RECEIVED_ITEMS, (packet, message) => {
			//if this is a sync packet reset all our item addresses without changing anything else
			if (packet.index == 0) {
				for (let flag in item_flags) {
					gpio[item_flags[flag][0]] &= (~item_flags[flag][1] << 28 >>> 28)
				}
			}
			//go through all our item addresses and if they are not set, check the recieved items for their ap id, and set the gpio flag if we recieved it
			//on the scale i expect pico-8 games to be, this will be good enough
			for (let flag in item_flags) {
				if (!(gpio[item_flags[flag][0]] & item_flags[flag][1])) {
					for (let i=0; i<packet.items.length; i++) {
						let item = packet.items[i]
						if (base_id + item_flags[flag][2] === item.item) {
							console.log(`adding item ${flag}`)
							gpio[item_flags[flag][0]] |= item_flags[flag][1]
						}
					}
				}
			}
		});
        // Connect to the Archipelago server
        form.addEventListener("submit", (event) => {
        	event.preventDefault()
	        const connectionInfo = {
	            hostname: document.getElementById("Hostname").value,
	            port: Number(document.getElementById("Port").value),
	            game: "Air Delivery",
	            name: document.getElementById("Name").value,
	            items_handling: ITEMS_HANDLING_FLAGS.REMOTE_ALL,
	            version: {
	            	build: 0,
	            	major: 4,
	            	minor: 6,
	            },
	        };
	        console.log(connectionInfo.hostname)
	        console.log(connectionInfo.port)
	        console.log(connectionInfo.name)

        	client
	            .connect(connectionInfo)
	            .then(() => {
	                console.log("Connected to the server");
	                // You are now connected and authenticated to the server. You can add more code here if need be.
	            })
	            .catch((error) => {
	                console.error("Failed to connect:", error);
	                // Handle the connection error.
	            });
        });

        function connect() {
        	

        }

        // Disconnect from the server when unloading window.
        // window.addEventListener("beforeunload", () => {
        //     client.disconnect();
        // })

        // add location handler for gpio layer
		gpio.subscribe(function(newIndices) {
			for (let loc in loc_flags) {
				if ((gpio[loc_flags[loc][0]] & loc_flags[loc][1]) !== 0) {
					if (loc === "victory") {
						client.updateStatus(CLIENT_STATUS.GOAL)
					} else {
						client.locations.check(base_id + loc_flags[loc][2])
					}
				}
			}
		});


    </script>
</body></html>